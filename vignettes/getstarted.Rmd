---
title: "Introduction to imgw package (EN)"
author: "Czernecki B., Głogowski A., Nowosad J."
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(imgw)
library(tidyr)
library(dplyr)
options(scipen=999)
```

The main goal of the **imgw** package is to give a convenient and programmable access to the Polish database of meteorological and hydrological (archive)database.

It consists of tools that are:

- Giving more accessible access to the public data stored in the Institute of Meteorology and Water Management ([IMGW](https://dane.imgw.pl/))
- Downloading the selected data from among eleven different forms of data depending on the interval and the data type
- Providing the description of the parameters in two languages: Polish and English, as well as in the abbreviated form
<!--co jeszcze>-->

## Functions 

The **imgw** package consists of nine functions - four for meteorological data, four for hydrological data and one for  sounding meteo:

1. Meteorological data:

- `meteo_hourly()` - downloading meteorological the data with hourly interval 
- `meteo_daily()` - downloading meteorological the data with daily interval 
- `meteo_monthly()` - downloading meteorological the data with monthly interval 
- `meteo()` - downloading meteorological the data with interval the user want to choose 

2. Hydrological data: 

- `hydro()` - downloading hydrological the data with interval the user want to choose
- `hydro_daily()` - downloading hydrological the data with daily interval
- `hydro_monthly()` - downloading hyrological the data with monthly interval
- `hydro_annual()` - downloading hyrological the data with annual interval

3. Rawinsonde data: 

- `meteo_sounding()` -- downloading rawinsonde data (+metadata)

Most of the above mentioned unctions have similar arguments allowing to choose:

- `rank` - type of the stations `"synop"`, `"climate"`, `"precip"` (**only meteo functions**)
- `year` - vector of selected years (e.g., `1966:2000`)
- `status` - logical argument TRUE or FALSE; if TRUE the measurement statuses will be erased (**only meteo functions**)
- `coords` - logical argument TRUE or FALSE; if TRUE the coordinates are added to the stations
- `station` - selection of the stations; it can be the ID of stations (numeric) or name of the station (**CAPITAL LETTERS** (character))
- `col_names` - format of the columns names; three types of column names are possible: `"short"` - default, values with shorten names, `"full"` - full English description, `"polish"` - original names in the dataset

## Database

**imgw** also has a few additional databases:

- `hydro_abberv`/`meteo_abberv` - a dictionary containing all original descriptions of parameters in both languages and the abbreviations

```{r abberv,echo=FALSE}
abbev = meteo_abbrev
head(abbev)
```

- `hydro_stations`/`meteo_stations` - datasets of almost all meteorological/hydrological stations containing their ID, latitude, and longitude

```{r station,echo=FALSE}
station = meteo_stations
head(station)
```

## Application

We will show how to use our package and prepare the data for spatial analysis with the additional help of the [dplyr](https://cran.r-project.org/web/packages/dplyr/vignettes/dplyr.html) and [tidyr](https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html) packages.
Firstly, we download ten years (**2001-2010**) of monthly hydrological observations for all stations available and automatically add their spatial coordinates. 

```{r data, echo = FALSE}
h = hydro_monthly(year = 2001:2010, coords = TRUE)
head(h)
```

The `idex` variable represents id of the extremum, where `1` means minimum, `2` mean, and `3` maximum.^[You can find information about this in the `hydro_abbrev` dataset.]
Hydrologists often use the maximum value so we will filter the data and select only the station `id`, hydrological year (`hyy`), latitude `X` and longitude `Y`.
Next, we will calculate the mean maximum value of the flow on the stations in each year with **dplyr**'s `summarise()`, and spread data by year using **tidyr**'s `spread()` to get the annual means of maximum flow in the consecutive columns.

```{r filering}
h %>%
  filter(idex == 3) %>%
  select(id, X, Y, hyy, Q, mm) %>%
  group_by(hyy, id, X, Y) %>%
  summarise(annual_mean_Q = mean(Q, na.rm = TRUE)) %>%
  spread(hyy, annual_mean_Q)-> result
head(result)
```

<!-- The resulting table can be easily exported to any spatial software with a changing annual maximum annual average water flow rate over the decade for Poland as a whole. -->
The result represent changing  annual maximum average of water flow rate over the decade for all available stations in Poland. 
We can save it to:

 - `.csv` with: `write.csv(result, file = "result.csv", sep = ";",dec = ".", col.names = T, row.names = F)`. 
This command save our result to `result.csv` where column's separator is `;`, decimal is `.` we are saving the headers of columns and remove names of rows which are simply numbers of observation.

 - `.xlsx` with: `write.xlsx(result, file = "result.xlsx", sheetName = "Poland", append = FALSE)`
 This command save our result to result.xlsx with name of the sheet `Poland`. Argument `append=TRUE` add the sheet to already existing `xlsx` file.
 To save data in `.xlsx` you have first to install package with command: `install.packages("xlsx")`, and add it: `library(xlsx)`.
 
<!-- dodatkowo można pokazać jak zapisać wynik do formatu teskstowego/excela/przestrzennego -->
<!-- nie umiem zapisać do formatu przestrzennego -->
